<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>rpc list json</title>
</head>
<!--<script src="/static/js_vue_v3_5_13"></script>-->
<!--<link rel="stylesheet" href="/static/css_element_plus_index">-->
<!--<script src="/static/js_element_plus_v2_9_8"></script>-->
<style>
    /* 样式可以按照需求自行定义 */
    .accordion {
        border: 1px solid #0aaeb3;
        margin-bottom: 10px;
    }
    .accordion-header {
        margin-top:2px;
        background-color: #f4f4f4;
        padding: 10px;
        cursor: pointer;
    }
    .accordion-body {
        font-size: 12px;
        display: none;
        padding: 10px;
    }
    td {
        padding-left: 20px;
    }
    th {
        padding-left: 20px;
    }
</style>

<body>
    <button onclick="location.href='/'">首页</button>
    <dialog id="simple-dialog">
        <div><button onclick="dialogClose()">关闭</button></div>
        <textarea id="dialogRpcParams" rows="10" cols="60"></textarea>
        <div><button onclick="PostRpc()">POST</button></div>
        <textarea id="dialogRpcResult" rows="10" cols="60"></textarea>
    </dialog>
</body>
</html>
<script type="text/javascript">
var rpcDataList = null
var dialogShowDataIndex = 0
function FormatRpcDataList(dataList){
    dataList.forEach((dataOne, index) => {
        var rpcParams = {method:dataOne.MethodName}
        dataOne.Params.forEach((paramOne, pi) => {
            if(paramOne.IsSlice){
                switch (paramOne.ValueKind){
                    case 11:
                        rpcParams[paramOne.Name] = [0]
                        break
                    case 24:
                        rpcParams[paramOne.Name] = [""]
                        break
                }
            }else{
                switch (paramOne.ValueKind){
                    case 11:
                        rpcParams[paramOne.Name] = 0
                        break
                    case 24:
                        rpcParams[paramOne.Name] = ""
                        break
                }
            }
        })
        dataOne.RpcParams = JSON.stringify(rpcParams, null, 2)
        dataOne.RpcResult = ""
    });
    rpcDataList = dataList
}
//向对话框中导入数据
function dialogImportData(index){
    var rpcOne = rpcDataList[index]
    dialogShowDataIndex = index
    console.log(rpcOne)
    document.getElementById("dialogRpcParams").value = rpcOne.RpcParams
    document.getElementById("dialogRpcResult").value = rpcOne.RpcResult
    // document.getElementById("dialogRpcResult").value = ""
}
//关闭对话框
function dialogClose(){
    rpcDataList[dialogShowDataIndex].RpcParams = document.getElementById("dialogRpcParams").value
    rpcDataList[dialogShowDataIndex].RpcResult = document.getElementById("dialogRpcResult").value
    document.querySelector('#simple-dialog').close()
}
//请求RPC并返回结果
function PostRpc(){
    var params = document.getElementById("dialogRpcParams").value
    document.getElementById("dialogRpcResult").value = ""
    // console.log(params)
    fetch('/rpc/json', {method: 'POST',body: params})
        .then(response => response.json())
        .then(data => {
            console.log(data)
            document.getElementById("dialogRpcResult").value = JSON.stringify(data, null, 2)
        })
        .catch(error => {
            console.error('error', error)
            document.getElementById("dialogRpcResult").value = error
        });
    // document.getElementById("dialogRpcParams").value
    // document.querySelector('#simple-dialog').close()
}
const bodyParams = {
    method: 'rpclist',
}
const headJson = {
    method: 'POST',
    body: JSON.stringify(bodyParams),
};
fetch('/rpc/json', headJson)
    .then(response => response.json())
    .then(data => {
        console.log(data)
        FormatRpcDataList(data.Data.list)
        var newElement = document.createElement("div");
        // newElement.setAttribute("class","accordion")
        var innerHTML = ""
        for(var i=0; i<data.Data.list.length; i++){
            var rpcOne = data.Data.list[i]
            innerHTML += '<div class="accordion"><div class="accordion-header">\n' +
                '<div class="rpcName">'+rpcOne.MethodName+'<button class="rpcTestBt">测试</button></div>'+
                '<div class="rpcDesc">'+rpcOne.Desc+'</div>'+
                '</div>'
            //组装参数的html
            var paramsInnerHTML = "<div class=\"accordion-body\">"
            if(rpcOne.Params.length > 0){
                paramsInnerHTML += "<table>\n" +
                    "            <thead>\n" +
                    "            <tr>\n" +
                    "                <th>必要参数</th>\n" +
                    "                <th>参数名称</th>\n" +
                    "                <th>值类型</th>\n" +
                    "                <th>参数说明</th>\n" +
                    "            </tr>\n" +
                    "            </thead>\n" +
                    "            <tbody>"
                for(var j=0; j<rpcOne.Params.length; j++){
                    var paramOne = rpcOne.Params[j]
                    var paramType = "Unknown"
                    if(paramOne.ValueKind == 24){
                        paramType = "String"
                    }else if(paramOne.ValueKind == 5){
                        paramType = "Int32"
                    }else if(paramOne.ValueKind == 6){
                        paramType = "Int64"
                    }else if(paramOne.ValueKind == 10){
                        paramType = "Uint32"
                    }else if(paramOne.ValueKind == 11){
                        paramType = "Uint64"
                    }else if(paramOne.ValueKind == 14){
                        paramType = "Float64"
                    }
                    if(paramOne.IsSlice){paramType = "[]"+paramType}
                    paramsInnerHTML += "<tr>\n" +
                        "                <td>"+paramOne.Must+"</td>\n" +
                        "                <td>"+paramOne.Name+"</td>\n" +
                        "                <td>"+paramType+"</td>\n" +
                        "                <td>"+paramOne.Desc+"</td>\n" +
                        "            </tr>"
                }
                paramsInnerHTML += "</tbody>\n" +
                    "        </table>\n"
            }
            paramsInnerHTML += "</div>"
            paramsInnerHTML += "</div>"
            innerHTML += paramsInnerHTML
        }
        newElement.innerHTML = innerHTML
        document.body.appendChild(newElement)

        // 获取所有手风琴项的标题和内容
        const accordionHeaders = document.querySelectorAll('.accordion-header');
        const accordionBodies = document.querySelectorAll('.accordion-body');

        // 对每个手风琴项的标题添加点击事件监听
        accordionHeaders.forEach((header, index) => {
            header.addEventListener('click', () => {
                // 切换该手风琴项内容的显示状态
                if (accordionBodies[index].style.display === 'block') {
                    accordionBodies[index].style.display = 'none'; // 如果显示，则隐藏
                } else {
                    // 隐藏其他手风琴项内容，然后显示当前手风琴项内容
                    // accordionBodies.forEach((body) => { body.style.display = 'none' });
                    accordionBodies[index].style.display = 'block';
                }
            });
        });

        const rpcTestBt = document.querySelectorAll('.rpcTestBt');
        //给每个测试按钮添加事件
        rpcTestBt.forEach((header, index) => {
            header.addEventListener('click', (event) => {
                //
                dialogImportData(index)
                document.querySelector("#simple-dialog").showModal();
                event.stopPropagation(); // 阻止事件冒泡
            });
        });
    })
    .catch(error => console.error('error', error));
</script>
